---
import SubPageLayout from "../layouts/SubPageLayout.astro";
import TimelineEvent from "../components/timeline/TimelineEvent.astro";
import { getTimelineViewModel } from "../viewmodels/timelineViewModel";
import "../styles/timeline.css";
import Button from "../components/common/Button.astro";

const viewModel = await getTimelineViewModel();
const {
  categories,
  initialEvents: initialFilteredEvents,
  metadata,
  filterAll,
  events: allEvents,
} = viewModel;

const eventsJson = JSON.stringify(allEvents);
---

<SubPageLayout title={metadata.title}>
  {
    metadata.actions &&
      metadata.actions.map((action) => (
        <Button
          slot="actions"
          href={action.href}
          text={action.text}
          style={action.style}
          download={action.download}
          icon={action.icon}
          iconPosition={action.iconPosition}
          target={action.target}
          rel={action.rel}
          noMargin={true}
          wrapperClass="page-load-initial-state"
        />
      ))
  }
  <div class="timeline-controls">
    <div class="control-group category-tabs">
      <button type="button" class="category-tab" data-category="all" aria-pressed="true"
        >{filterAll}</button
      >
      {
        categories.map((cat) => (
          <button type="button" class="category-tab" data-category={cat}>
            {cat}
          </button>
        ))
      }
    </div>
    <!-- <div class="control-group">
      <button type="button" id="sort-toggle" data-sort-current="newest">Newest First</button>
    </div> -->
  </div>

  <ul class="timeline-container mt-8" id="timeline-container">
    {/* Initial server-side render */}
    {
      initialFilteredEvents.map((event, index) => (
        <TimelineEvent
          date={event.date}
          dateRange={event.dateRange}
          title={event.title}
          description={event.description}
          category={event.category}
          isLast={index === initialFilteredEvents.length - 1}
        />
      ))
    }
  </ul>

  {/* Data serialization for client-side hydration */}
  <script is:inline type="application/json" id="timeline-data" set:html={eventsJson} />
</SubPageLayout>

<script>
  import { TimelineController, type TimelineEvent } from "../lib/controllers/TimelineController";

  document.addEventListener("astro:page-load", () => {
    const dataEl = document.getElementById("timeline-data");
    if (!dataEl) return;

    try {
      const events = JSON.parse(dataEl.textContent || "[]") as TimelineEvent[];
      new TimelineController("#timeline-container", events, ".category-tab", "sort-toggle");
    } catch (e) {
      console.error("Failed to initialize TimelineController", e);
    }
  });
</script>

<style>
  .timeline-controls {
    margin-bottom: 3rem;
    display: flex;
    flex-wrap: wrap;
    gap: 1.5rem;
    align-items: center;
  }
  .control-group {
    display: flex;
    flex-wrap: wrap;
    gap: 0.8rem;
    align-items: center;
  }
  .control-group label {
    font-weight: 500;
    margin-right: 0.5rem;
    color: var(--text-muted);
  }

  .controls-note {
    font-size: 0.85rem;
    color: var(--text-muted);
    width: 100%;
    text-align: right;
    margin: 0.5rem 0 0;
  }

  .timeline-container {
    padding: 0;
    margin: 0;
    /* No specific layout needed here, handled by list items */
  }

  /* Category Tabs Styling */
  .category-tabs {
    gap: 0.5rem 0rem;
    font-family: var(--font-family-sans);
  }
  .category-tab {
    font-family: inherit;
    font-size: 1rem;
    padding: 0.5em 1em 0.8em;
    border: none;
    border-bottom-width: 3px;
    border-bottom-style: solid;
    border-bottom-color: transparent;
    background-color: transparent;
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.2s ease;
    margin-bottom: -1px;
  }
  .category-tab:hover {
    border-bottom-color: var(--button-border-color);
    color: var(--text-color);
  }
  .category-tab[aria-pressed="true"] {
    border-bottom-color: var(--button-border-hover-color);
    color: var(--text-color);
    font-weight: 600;
  }

  #sort-toggle {
    font-family: inherit;
    font-size: 0.9rem;
    padding: 0.4em 0.9em;
    border-radius: 6px;
    border: 1px solid var(--button-border-hover-color);
    background-color: var(--button-hover-bg);
    color: var(--button-hover-text);
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  #sort-toggle:hover {
    border-color: var(--button-border-color);
    background-color: transparent;
    color: var(--text-muted);
  }

  .timeline-container {
    /* Add transition for smoother effect when class is removed */
    transition: opacity 0.3s ease-out;
    /* padding/margin already exist */
    padding: 0;
    margin: 0;
  }

  .timeline-container.is-updating {
    opacity: 0;
    /* You could use animation instead if preferred */
    /* animation: fadeOut 0.3s ease-out forwards; */
  }

  /* Consider users who prefer reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .timeline-container,
    .timeline-container.is-updating {
      transition: none;
      animation: none;
      opacity: 1; /* Ensure it's always visible */
    }
  }
</style>
