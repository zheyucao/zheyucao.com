---
import SubPageLayout from "../layouts/SubPageLayout.astro";
import EventEntry from "../components/events/EventEntry.astro";
import { getEventsViewModel } from "../viewmodels/eventsViewModel";
import "../styles/events.css";
import PageActions from "../components/common/PageActions.astro";

const viewModel = await getEventsViewModel();
const { categories, initialEvents: initialFilteredEvents, metadata, filterAll } = viewModel;
---

<SubPageLayout title={metadata.title} description={metadata.description} seo={metadata.seo}>
  <PageActions actions={metadata.actions} />
  <div class="timeline-controls">
    <div class="control-group category-tabs">
      <button type="button" class="category-tab" data-category="all" aria-pressed="true"
        >{filterAll}</button
      >
      {
        categories.map((cat) => (
          <button type="button" class="category-tab" data-category={cat}>
            {cat}
          </button>
        ))
      }
    </div>
  </div>
  <ul class="timeline-container mt-8" id="timeline-container">
    {
      initialFilteredEvents.map((event, index) => (
        <EventEntry
          date={event.date}
          dateRange={event.dateRange}
          title={event.title}
          description={event.description}
          Content={event.Content}
          category={event.category}
          isLast={index === initialFilteredEvents.length - 1}
        />
      ))
    }
  </ul>
</SubPageLayout>

<script>
  import { EventFilterController } from "../lib/controllers/EventFilterController";

  const TIMELINE_EVENTS_KEY = "__timelineEventsRegistered__";
  type TimelineWindow = Window & {
    [TIMELINE_EVENTS_KEY]?: boolean;
  };
  const timelineWindow = window as TimelineWindow;

  if (!timelineWindow[TIMELINE_EVENTS_KEY]) {
    timelineWindow[TIMELINE_EVENTS_KEY] = true;

    let controller: EventFilterController | null = null;

    const initTimeline = () => {
      try {
        // Clean up any previous instance before creating a new one
        controller?.destroy();
        const containerExists = document.querySelector("#timeline-container");
        const tabsExist = document.querySelectorAll(".category-tab").length > 0;
        if (!containerExists || !tabsExist) return;
        controller = new EventFilterController("#timeline-container", ".category-tab");
      } catch (e) {
        console.error("Failed to initialize EventFilterController", e);
      }
    };

    const cleanupTimeline = () => {
      controller?.destroy();
      controller = null;
    };

    // Run immediately in case the event fired before this script executes
    initTimeline();
    document.addEventListener("astro:page-load", initTimeline);
    document.addEventListener("astro:before-swap", cleanupTimeline);
  }
</script>

<style>
  .timeline-controls {
    margin-bottom: 3rem;
    display: flex;
    flex-wrap: wrap;
    gap: 1.5rem;
    align-items: center;
  }
  .control-group {
    display: flex;
    flex-wrap: wrap;
    gap: 0.8rem;
    align-items: center;
  }
  .control-group label {
    font-weight: 500;
    margin-right: 0.5rem;
    color: var(--text-muted);
  }

  .controls-note {
    font-size: 0.85rem;
    color: var(--text-muted);
    width: 100%;
    text-align: right;
    margin: 0.5rem 0 0;
  }

  .timeline-container {
    padding: 0;
    margin: 0;
    /* No specific layout needed here, handled by list items */
  }

  /* Category Tabs Styling */
  .category-tabs {
    gap: 0.5rem 0rem;
    font-family: var(--font-family-sans);
  }
  .category-tab {
    font-family: inherit;
    font-size: 1rem;
    padding: 0.5em 1em 0.8em;
    border: none;
    border-bottom-width: 3px;
    border-bottom-style: solid;
    border-bottom-color: transparent;
    background-color: transparent;
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.2s ease;
    margin-bottom: -1px;
  }
  .category-tab:hover {
    border-bottom-color: var(--button-border-color);
    color: var(--text-color);
  }
  .category-tab[aria-pressed="true"] {
    border-bottom-color: var(--button-border-hover-color);
    color: var(--text-color);
    font-weight: 600;
  }

  #sort-toggle {
    font-family: inherit;
    font-size: 0.9rem;
    padding: 0.4em 0.9em;
    border-radius: 6px;
    border: 1px solid var(--button-border-hover-color);
    background-color: var(--button-hover-bg);
    color: var(--button-hover-text);
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  #sort-toggle:hover {
    border-color: var(--button-border-color);
    background-color: transparent;
    color: var(--text-muted);
  }

  .timeline-container {
    /* Add transition for smoother effect when class is removed */
    transition: opacity 0.3s ease-out;
    /* padding/margin already exist */
    padding: 0;
    margin: 0;
  }

  .timeline-container.is-updating {
    opacity: 0;
    /* You could use animation instead if preferred */
    /* animation: fadeOut 0.3s ease-out forwards; */
  }

  /* Consider users who prefer reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .timeline-container,
    .timeline-container.is-updating {
      transition: none;
      animation: none;
      opacity: 1; /* Ensure it's always visible */
    }
  }
</style>
