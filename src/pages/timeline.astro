---
import SubPageLayout from "../layouts/SubPageLayout.astro";
import EventEntry from "../components/events/EventEntry.astro";
import { getEventsViewModel } from "../viewmodels/eventsViewModel";
import PageActions from "../components/common/PageActions.astro";
import { resolveLocaleFromPath } from "../lib/i18n/locale";

const locale = resolveLocaleFromPath(Astro.url.pathname);
const viewModel = await getEventsViewModel(locale);
const { categories, initialEvents: initialFilteredEvents, metadata, filterAll } = viewModel;
---

<SubPageLayout title={metadata.title} description={metadata.description} seo={metadata.seo}>
  <PageActions slot="actions" actions={metadata.actions} />
  <div class="mb-12 flex flex-wrap gap-6 items-center">
    <!-- Category Tabs -->
    <div class="flex flex-wrap gap-x-3 gap-y-2 items-center font-sans">
      <button
        type="button"
        class="category-tab font-inherit text-[1rem] px-4 pb-[0.8em] pt-[0.5em] border-none border-b-3 border-transparent bg-transparent text-text-muted cursor-pointer transition-all duration-200 -mb-[1px] hover:border-button-border hover:text-text aria-pressed:border-button-border-hover aria-pressed:text-text aria-pressed:font-semibold"
        data-category="all"
        aria-pressed="true">{filterAll}</button
      >
      {
        categories.map((cat) => (
          <button
            type="button"
            class="category-tab font-inherit text-[1rem] px-4 pb-[0.8em] pt-[0.5em] border-none border-b-3 border-transparent bg-transparent text-text-muted cursor-pointer transition-all duration-200 -mb-[1px] hover:border-button-border hover:text-text aria-pressed:border-button-border-hover aria-pressed:text-text aria-pressed:font-semibold"
            data-category={cat}
          >
            {cat}
          </button>
        ))
      }
    </div>
  </div>
  <ul
    class="timeline-container p-0 m-0 transition-opacity duration-300 ease-out motion-reduce:transition-none motion-reduce:animate-none motion-reduce:opacity-100 [&.is-updating]:opacity-0"
    id="timeline-container"
  >
    {
      initialFilteredEvents.map((event, index) => (
        <EventEntry
          date={event.date}
          dateRange={event.dateRange}
          title={event.title}
          description={event.description}
          Content={event.Content}
          category={event.category}
          isLast={index === initialFilteredEvents.length - 1}
        />
      ))
    }
  </ul>
</SubPageLayout>

<script>
  import { EventFilterController } from "../lib/controllers/EventFilterController";

  const TIMELINE_EVENTS_KEY = "__timelineEventsRegistered__";
  type TimelineWindow = Window & {
    [TIMELINE_EVENTS_KEY]?: boolean;
  };
  const timelineWindow = window as TimelineWindow;

  if (!timelineWindow[TIMELINE_EVENTS_KEY]) {
    timelineWindow[TIMELINE_EVENTS_KEY] = true;

    let controller: EventFilterController | null = null;

    const initTimeline = () => {
      try {
        // Clean up any previous instance before creating a new one
        controller?.destroy();
        const containerExists = document.querySelector("#timeline-container");
        const tabsExist = document.querySelectorAll(".category-tab").length > 0;
        if (!containerExists || !tabsExist) return;
        controller = new EventFilterController("#timeline-container", ".category-tab");
      } catch (e) {
        console.error("Failed to initialize EventFilterController", e);
      }
    };

    const cleanupTimeline = () => {
      controller?.destroy();
      controller = null;
    };

    // Run immediately in case the event fired before this script executes
    initTimeline();
    document.addEventListener("astro:page-load", initTimeline);
    document.addEventListener("astro:before-swap", cleanupTimeline);
  }
</script>
