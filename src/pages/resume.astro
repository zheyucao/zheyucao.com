---
import SubPageLayout from "../layouts/SubPageLayout.astro";
import ResumeSectionRenderer from "../components/resume/ResumeSectionRenderer.astro";
import Button from "../components/common/Button.astro";
import { getCollection, getEntry } from "astro:content";

// Fetch profile
const profileEntry = await getEntry("resume-profile", "profile");
const { Content: ProfileContent } = await profileEntry.render();

// Fetch education entries
const educationEntries = await getCollection("resume-education");
const education = await Promise.all(
  educationEntries.map(async (entry) => {
    const { Content } = await entry.render();
    return {
      title: entry.data.title,
      subtitle: entry.data.subtitle,
      date: entry.data.date,
      Content,
    };
  })
);

// Fetch experience entries
const experienceEntries = await getCollection("resume-experience");
const experience = await Promise.all(
  experienceEntries.map(async (entry) => {
    const { Content } = await entry.render();
    return {
      title: entry.data.title,
      subtitle: entry.data.subtitle,
      date: entry.data.date,
      Content,
    };
  })
);

// Fetch project entries
const projectEntries = await getCollection("resume-projects");
const projects = await Promise.all(
  projectEntries.map(async (entry) => {
    const { Content } = await entry.render();
    return {
      title: entry.data.title,
      date: entry.data.date,
      Content,
    };
  })
);

// Fetch awards data
const awardsData = await getEntry("resume-data", "awards");

// Fetch skills data
const skillsData = await getEntry("resume-data", "skills");

// Fetch contact data
const contactData = await getEntry("resume-data", "contact");

// Build mainColumn and sidebar structure
const mainColumn = [
  {
    id: "profile",
    title: profileEntry.data.title,
    type: "text",
    Content: ProfileContent,
  },
  {
    id: "education",
    title: "Education",
    type: "entries",
    content: education,
  },
  {
    id: "awards",
    title: awardsData.data.title,
    type: "entries",
    content: awardsData.data.content,
  },
  {
    id: "experience",
    title: "Experience",
    type: "entries",
    content: experience,
  },
  {
    id: "projects",
    title: "Projects",
    type: "entries",
    content: projects,
  },
];

const sidebar = [
  {
    id: "skills",
    title: skillsData.data.title,
    type: "skills",
    content: skillsData.data.content,
  },
  {
    id: "contact",
    title: contactData.data.title,
    type: "contact",
    content: contactData.data.content,
  },
];
---

<SubPageLayout title="Résumé">
  <Button
    slot="actions"
    href="https://assets.zheyucao.com/resume.pdf"
    text="PDF (Chinese)"
    style="primary"
    download="Zheyu_Cao_Resume_ZH.pdf"
    icon="↓"
    iconPosition="left"
    target="_blank"
    rel="noopener noreferrer"
    noMargin={true}
    wrapperClass="page-load-initial-state"
  />

  <div class="resume-container">
    <div class="main-column">
      {mainColumn.map((section) => <ResumeSectionRenderer section={section} />)}
    </div>

    <aside class="sidebar">
      {sidebar.map((section) => <ResumeSectionRenderer section={section} />)}
    </aside>
  </div>
</SubPageLayout>

<style>
  .resume-container {
    display: grid;
    grid-template-columns: 1fr 240px;
    gap: 4rem;
    max-width: 1200px;
    margin: 0 auto;
  }

  .main-column {
    min-width: 0; /* Prevent overflow in grid items */
  }

  .sidebar {
    position: sticky;
    top: 2rem;
    height: fit-content;
  }

  .download-section {
    margin-bottom: 3rem;
  }

  @media (max-width: 900px) {
    .resume-container {
      grid-template-columns: 1fr;
      gap: 3rem;
    }

    .sidebar {
      position: static;
    }

    /* But maybe we want contact info at bottom on mobile? 
       For now, let's keep it simple. The user can reorder in data if needed. 
       Actually, typically download is top, contact is top or bottom. 
       With the current data structure, sidebar has both. 
    */
  }
</style>
