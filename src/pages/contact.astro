---
import SubPageLayout from "../layouts/SubPageLayout.astro";
import { getContactViewModel } from "../viewmodels/contactViewModel";
import { Icon } from "astro-icon/components";
import Tooltip from "../components/common/Tooltip.astro";
import Button from "../components/common/Button.astro";

const { intro, sections, metadata } = await getContactViewModel();
---

<SubPageLayout title={metadata.title}>
  {
    metadata.actions &&
      metadata.actions.map((action) => (
        <Button
          slot="actions"
          href={action.href}
          text={action.text}
          style={action.style}
          download={action.download}
          icon={action.icon}
          iconPosition={action.iconPosition}
          target={action.target}
          rel={action.rel}
          noMargin={true}
          wrapperClass="page-load-initial-state"
        />
      ))
  }
  <div class="contact-content">
    {
      intro && (
        <div class="intro-text">
          <intro.Content />
        </div>
      )
    }

    {
      sections.map((section) => (
        <>
          <div class="section-prose">
            <section.Content />
          </div>
          <ul class="contact-list">
            {section.items.map((item) => (
              <li>
                <Icon name={item.icon} class="contact-icon" />
                {(() => {
                  const value = item.content || "";
                  const description = item.description;
                  const copyValue = item.href ? undefined : value;

                  if (item.href) {
                    return (
                      <>
                        <a href={item.href} target={item.target} rel={item.rel}>
                          {value}
                        </a>
                        {description && <span class="inline-desc">&nbsp;{description}</span>}
                      </>
                    );
                  }

                  if (copyValue) {
                    return (
                      <>
                        <Tooltip
                          class="copy-only-tooltip"
                          label="Copied!"
                          position="bottom"
                          trigger="click"
                        >
                          <span
                            class:list={["copyable", { clickable: true }]}
                            data-copy-value={copyValue}
                          >
                            {value}
                          </span>
                        </Tooltip>
                        {description && <span class="inline-desc">&nbsp;{description}</span>}
                      </>
                    );
                  }

                  return (
                    <>
                      <span>{value}</span>
                      {description && <span class="inline-desc">&nbsp;{description}</span>}
                    </>
                  );
                })()}
              </li>
            ))}
          </ul>
        </>
      ))
    }
  </div>
</SubPageLayout>

<style>
  .contact-content {
    max-width: 600px;
  }

  .intro-text {
    margin-bottom: 1rem; /* Reduced margin */
    font-size: 1.2em;
    line-height: 1.7;
    color: var(--text-muted);
  }

  .section-prose {
    font-size: 1.2rem;
    line-height: 1.7;
    color: var(--text-heading-color);
    margin-top: 3rem;
    margin-bottom: 1.5rem;
  }

  .contact-list {
    list-style: none;
    padding-left: 0;
    margin: 0;
    line-height: 1.9;
  }
  .contact-list li {
    margin-bottom: 1.2rem;
    display: flex;
    align-items: flex-start; /* Align icon to top of text */
    font-size: 1.2rem;
  }
  .contact-icon {
    margin-right: 1em;
    font-size: 1.3em;
    flex-shrink: 0;
    opacity: 0.9;
    /* transform: translateY(0.08em); */ /* Removed transform, using align-items: flex-start */
    color: var(--icon-color);
    margin-top: 0.3em; /* Align icon slightly lower */
  }

  .contact-list a,
  .contact-list span {
    word-break: break-all;
  }

  .contact-list a {
    color: var(--link-color);
    text-decoration: none;
    transition: color 0.3s ease;
  }
  .contact-list a:hover {
    color: var(--link-hover-color);
    text-decoration: underline;
  }

  .inline-desc {
    color: var(--text-muted);
  }

  .section-divider {
    border: 0;
    height: 1px;
    background: var(--button-border-color);
    margin: 3rem 0; /* Space around divider */
  }

  /* Remove label styles as they are no longer used */
</style>

<script>
  const handleCopy = async (el: HTMLElement, value: string) => {
    if (!value) return;
    const tooltip = el.closest(".tooltip");
    const bubble = tooltip?.querySelector(".tooltip-bubble");
    const labelEl = tooltip?.querySelector("[data-tooltip-label]");
    const descEl = tooltip?.querySelector("[data-tooltip-desc]") as HTMLElement | null;

    try {
      await navigator.clipboard.writeText(value);
      if (labelEl) {
        const originalLabel =
          labelEl.getAttribute("data-original-label") || labelEl.textContent || "Copied!";
        labelEl.textContent = "Copied!";
        if (descEl) descEl.style.display = "none";
        if (bubble) bubble.classList.add("copy-active");
        setTimeout(() => {
          labelEl.textContent = originalLabel;
          if (descEl) descEl.style.display = "";
          if (bubble) bubble.classList.remove("copy-active");
        }, 1200);
      }
    } catch (e) {
      console.error("Unable to copy contact value:", e);
    }
  };

  document.addEventListener("astro:page-load", () => {
    const copyTargets = document.querySelectorAll<HTMLElement>(".contact-list [data-copy-value]");
    copyTargets.forEach((el) => {
      el.addEventListener("click", (event) => {
        const value = el.getAttribute("data-copy-value");
        if (!value) return;
        event.preventDefault();
        handleCopy(el, value);
      });
    });
  });
</script>
