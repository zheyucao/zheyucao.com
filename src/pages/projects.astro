---
import { getCollection } from "astro:content";
import SubPageLayout from "../layouts/SubPageLayout.astro";
import ProjectCard from "../components/projects/ProjectCard.astro";
import { projectsContent } from "../data/siteContent";

// Fetch projects from collection
const allProjects = await getCollection("projects");

// Render content for each project
const projects = await Promise.all(
  allProjects.map(async (project) => {
    const { Content } = await project.render();
    return { ...project, Content };
  })
);

// Sort projects if needed (e.g. by timeframe or a sortOrder field)
// For now, we rely on the order returned or add a sort logic later.
// projectsData.ts was an array, so order was explicit.
// Collections are unordered by default unless sorted.
// I should probably add an 'order' field or sort by date.
// For now, I'll leave it as is (file system order might vary).
// Actually, I should sort them to match the original order if possible.
// But I don't have dates for all.
// I'll just render them.
---

<SubPageLayout title="Projects">
  <p class="page-intro">
    {projectsContent.intro}
  </p>
  <div class="projects-grid">
    {
      projects.map((project) => (
        <ProjectCard
          id={project.slug}
          title={project.data.title}
          timeframe={project.data.timeframe}
          imageSrc={project.data.imageSrc}
          imageAlt={project.data.imageAlt}
          githubUrl={project.data.githubUrl}
          projectUrl={project.data.projectUrl}
          githubRepos={project.data.githubRepos}
          techStack={project.data.techStack}
        >
          <project.Content />
        </ProjectCard>
      ))
    }
  </div>
</SubPageLayout>

<script>
  import { gsap } from "gsap";
  import { ScrollToPlugin } from "gsap/ScrollToPlugin";

  gsap.registerPlugin(ScrollToPlugin);

  function smoothScrollToTarget() {
    console.log("[projects.astro] smoothScrollToTarget triggered.");
    const params = new URLSearchParams(window.location.search);
    const targetId = params.get("scrollTo");
    console.log("[projects.astro] Target ID from URL:", targetId);

    if (targetId) {
      setTimeout(() => {
        console.log("[projects.astro] Inside setTimeout. Attempting to find elements...");
        const targetElement = document.getElementById(targetId);
        const pageWrapperElement = document.querySelector(".page-wrapper") as HTMLElement | null;
        console.log("[projects.astro] Found target element:", targetElement);
        console.log("[projects.astro] Found page wrapper:", pageWrapperElement);

        if (targetElement && pageWrapperElement) {
          // Ensure both elements exist
          console.log("[projects.astro] Both elements found. Calculating position...");
          // Calculate the target scroll position *within* the pageWrapper
          const targetOffsetTopInWrapper = targetElement.offsetTop;
          const finalScrollPosition = targetOffsetTopInWrapper; // Offset relative to wrapper top

          console.log(
            `[projects.astro] Target offsetTop: ${targetOffsetTopInWrapper}, Final scroll position: ${finalScrollPosition}`
          );

          console.log("[projects.astro] Initiating GSAP scroll on .page-wrapper...");
          gsap.to(pageWrapperElement, {
            // Target the page wrapper
            duration: 1,
            scrollTo: {
              y: finalScrollPosition, // Scroll the wrapper to this position
              // autoKill: false // Might sometimes help if other triggers interfere, but let's omit for now
            },
            ease: "power4.out",
            onComplete: () => {
              console.log("[projects.astro] GSAP scroll completed.");
            }, // Log completion
            onStart: () => {
              console.log("[projects.astro] GSAP scroll started.");
            }, // Log start
            onInterrupt: () => {
              console.log("[projects.astro] GSAP scroll interrupted!");
            }, // Log interruption
          });

          // Clean URL immediately
          try {
            history.replaceState(null, "", window.location.pathname);
          } catch (e) {
            console.error("Could not clean URL state:", e);
          }
        } else {
          if (!targetElement)
            console.warn(`[projects.astro] Element with id "${targetId}" not found.`);
          if (!pageWrapperElement)
            console.warn(`[projects.astro] .page-wrapper element not found.`);
          // Clean URL even if target not found
          try {
            history.replaceState(null, "", window.location.pathname);
          } catch {
            // Intentionally ignore errors during this specific cleanup attempt
          }
        }
      }, 100); // Keep a small delay (adjust if necessary)
    } else {
      console.log("[projects.astro] No 'scrollTo' parameter found.");
    }
  }

  document.addEventListener("astro:page-load", smoothScrollToTarget);

  // Optional: Run on initial load if needed, test if astro:page-load is sufficient
  // smoothScrollToTarget();
</script>

<style>
  .page-intro {
    font-size: 1.2rem;
    color: var(--text-muted);
    margin-bottom: 3rem;
    max-width: 70ch;
  }
  .projects-grid {
    /* display: grid; */ /* Remove grid display */
    /* grid-template-columns: repeat(auto-fit, minmax(380px, 1fr)); */
    /* align-items: start; */

    /* Use CSS Columns */
    column-count: 1; /* Default to 1 column on mobile */
    column-gap: 3rem; /* Adjust gap */
    gap: 3rem; /* Keep vertical gap between items in the same column */
  }

  /* Apply multi-column layout for wider screens */
  @media (min-width: 1024px) {
    .projects-grid {
      column-count: 2;
      column-gap: 3rem; /* Use the larger gap for desktop */
      gap: 3rem;
    }
  }

  /* Ensure cards don't break across columns */
  .projects-grid > :global(.project-card) {
    break-inside: avoid;
    /* margin-bottom is handled by the grid gap, but ensure it exists */
    /* margin-bottom: 3rem; */
  }
</style>
