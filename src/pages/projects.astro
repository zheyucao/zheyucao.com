---
import SubPageLayout from "../layouts/SubPageLayout.astro";
import ProjectCard from "../components/projects/ProjectCard.astro";
import { getProjectsViewModel } from "../viewmodels/projectsViewModel";
import Button from "../components/common/Button.astro";

const { projects, metadata } = await getProjectsViewModel();
---

<SubPageLayout title={metadata.title}>
  {
    metadata.actions &&
      metadata.actions.map((action) => (
        <Button
          slot="actions"
          href={action.href}
          text={action.text}
          style={action.style}
          download={action.download}
          icon={action.icon}
          iconPosition={action.iconPosition}
          target={action.target}
          rel={action.rel}
          noMargin={true}
          wrapperClass="page-load-initial-state"
        />
      ))
  }
  <div class="projects-grid columns-1 gap-x-12 md:columns-2">
    {
      projects.map((project) => (
        <ProjectCard
          id={project.id}
          title={project.data.title}
          imageSrc={project.data.imageSrc}
          imageAlt={project.data.imageAlt}
          date={project.formattedDate}
          projectUrl={project.data.projectUrl}
          githubUrl={project.data.githubUrl}
          githubRepos={project.data.githubRepos}
          techStack={project.data.techStack}
        >
          <project.Content />
        </ProjectCard>
      ))
    }
  </div>
</SubPageLayout>

<script>
  import { gsap, registerGsapPlugins } from "../lib/animations/gsapPlugins";
  import { prefersReducedMotion } from "../lib/utils/motionPreferences";

  registerGsapPlugins();

  const SCROLL_TO_KEY = "__projectScrollToEventsRegistered__";
  type ScrollWindow = Window & { [SCROLL_TO_KEY]?: boolean };
  const scrollWindow = window as ScrollWindow;

  if (!scrollWindow[SCROLL_TO_KEY]) {
    scrollWindow[SCROLL_TO_KEY] = true;

    let scrollTimeoutId: number | null = null;

    function smoothScrollToTarget() {
      const params = new URLSearchParams(window.location.search);
      const targetId = params.get("scrollTo");

      if (targetId) {
        return window.setTimeout(() => {
          const targetElement = document.getElementById(targetId);
          const pageWrapperElement = document.querySelector(".page-wrapper") as HTMLElement | null;

          if (targetElement && pageWrapperElement) {
            const targetOffsetTopInWrapper = targetElement.offsetTop;
            const finalScrollPosition = targetOffsetTopInWrapper;

            if (prefersReducedMotion()) {
              pageWrapperElement.scrollTo({ top: finalScrollPosition, behavior: "auto" });
              const newUrl = window.location.pathname;
              window.history.replaceState({}, "", newUrl);
              return;
            }

            gsap.to(pageWrapperElement, {
              duration: 1,
              scrollTo: {
                y: finalScrollPosition,
              },
              ease: "power4.out",
              onComplete: () => {
                const newUrl = window.location.pathname;
                window.history.replaceState({}, "", newUrl);
              },
            });
          }
        }, 100);
      }

      return null;
    }

    const handlePageLoad = () => {
      if (scrollTimeoutId !== null) {
        clearTimeout(scrollTimeoutId);
      }
      scrollTimeoutId = smoothScrollToTarget();
    };

    const handleBeforeSwap = () => {
      if (scrollTimeoutId !== null) {
        clearTimeout(scrollTimeoutId);
        scrollTimeoutId = null;
      }
    };

    document.addEventListener("astro:page-load", handlePageLoad);
    document.addEventListener("astro:before-swap", handleBeforeSwap);
  }
</script>

<style>
  /* Multi-column specific styling */
  .projects-grid > :global(.project-card) {
    break-inside: avoid;
    margin-bottom: 3rem;
  }

  .projects-grid > :global(.project-card:last-child) {
    margin-bottom: 0;
  }
</style>
