---
import SubPageLayout from "../layouts/SubPageLayout.astro";
import ProjectCard from "../components/projects/ProjectCard.astro";
import { getProjectsViewModel } from "../viewmodels/projectsViewModel";

const { projects, pageTitle } = await getProjectsViewModel();
---

<SubPageLayout title={pageTitle}>
  <div class="projects-grid">
    {
      projects.map((project) => (
        <ProjectCard
          id={project.slug}
          title={project.data.title}
          timeframe={project.data.timeframe}
          imageSrc={project.data.imageSrc}
          imageAlt={project.data.imageAlt}
          githubUrl={project.data.githubUrl}
          projectUrl={project.data.projectUrl}
          githubRepos={project.data.githubRepos}
          techStack={project.data.techStack}
        >
          <project.Content />
        </ProjectCard>
      ))
    }
  </div>
</SubPageLayout>

<script>
  import { gsap } from "gsap";
  import { ScrollToPlugin } from "gsap/ScrollToPlugin";

  gsap.registerPlugin(ScrollToPlugin);

  function smoothScrollToTarget() {
    const params = new URLSearchParams(window.location.search);
    const targetId = params.get("scrollTo");

    if (targetId) {
      setTimeout(() => {
        const targetElement = document.getElementById(targetId);
        const pageWrapperElement = document.querySelector(".page-wrapper") as HTMLElement | null;

        if (targetElement && pageWrapperElement) {
          const targetOffsetTopInWrapper = targetElement.offsetTop;
          const finalScrollPosition = targetOffsetTopInWrapper;

          gsap.to(pageWrapperElement, {
            duration: 1,
            scrollTo: {
              y: finalScrollPosition,
            },
            ease: "power4.out",
            onComplete: () => {
              const newUrl = window.location.pathname;
              window.history.replaceState({}, "", newUrl);
            },
          });
        }
      }, 100);
    }
  }

  document.addEventListener("astro:page-load", () => {
    smoothScrollToTarget();
  });
</script>

<style>
  .projects-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(min(100%, 400px), 1fr));
    column-gap: 3rem;
    row-gap: 5rem;
    margin-top: 3rem;
  }

  @media (max-width: 900px) {
    .projects-grid {
      grid-template-columns: 1fr;
      row-gap: 4rem;
    }
  }

  /* Prevent grid blowout from long words inside project cards */
  .projects-grid > :global(*) {
    min-width: 0; /* Allows grid items to shrink below their content size if needed */
  }
</style>
