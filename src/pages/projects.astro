---
import SubPageLayout from "../layouts/SubPageLayout.astro";
import ProjectCard from "../components/projects/ProjectCard.astro";
import { getProjectsViewModel } from "../viewmodels/projectsViewModel";

const { projects, pageTitle } = await getProjectsViewModel();
---

<SubPageLayout title={pageTitle}>
  <div class="projects-grid">
    {
      projects.map((project) => (
        <ProjectCard
          id={project.slug}
          title={project.data.title}
          imageSrc={project.data.imageSrc}
          imageAlt={project.data.imageAlt}
          timeframe={project.data.timeframe}
          projectUrl={project.data.projectUrl}
          githubUrl={project.data.githubUrl}
          githubRepos={project.data.githubRepos}
          techStack={project.data.techStack}
        >
          <project.Content />
        </ProjectCard>
      ))
    }
  </div>
</SubPageLayout>

<script>
  import { gsap } from "gsap";
  import { ScrollToPlugin } from "gsap/ScrollToPlugin";

  gsap.registerPlugin(ScrollToPlugin);

  function smoothScrollToTarget() {
    const params = new URLSearchParams(window.location.search);
    const targetId = params.get("scrollTo");

    if (targetId) {
      setTimeout(() => {
        const targetElement = document.getElementById(targetId);
        const pageWrapperElement = document.querySelector(".page-wrapper") as HTMLElement | null;

        if (targetElement && pageWrapperElement) {
          const targetOffsetTopInWrapper = targetElement.offsetTop;
          const finalScrollPosition = targetOffsetTopInWrapper;

          gsap.to(pageWrapperElement, {
            duration: 1,
            scrollTo: {
              y: finalScrollPosition,
            },
            ease: "power4.out",
            onComplete: () => {
              const newUrl = window.location.pathname;
              window.history.replaceState({}, "", newUrl);
            },
          });
        }
      }, 100);
    }
  }

  document.addEventListener("astro:page-load", () => {
    smoothScrollToTarget();
  });
</script>

<style>
  .projects-grid {
    column-count: 1;
    column-gap: 3rem;
  }

  @media (min-width: 768px) {
    .projects-grid {
      column-count: 2;
      column-gap: 3rem;
    }
  }

  .projects-grid > :global(.project-card) {
    break-inside: avoid;
    margin-bottom: 3rem;
  }

  .projects-grid > :global(.project-card:last-child) {
    margin-bottom: 0;
  }
</style>
