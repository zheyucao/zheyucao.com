---
import { ClientRouter } from "astro:transitions";
import DynamicBackground from "../components/DynamicBackground.astro";
import ScrollIndicator from "../components/ScrollIndicator.astro";
import Footer from "../components/Footer.astro";
import { siteConfig } from "../config";
import "../styles/global.css";

// Define props interface and get the title prop
interface Props {
  title?: string; // Optional title prop
  showIndicatorOverride?: boolean; // Add override prop
}
const { title, showIndicatorOverride } = Astro.props;

// --- Add Detailed Log ---
console.log(
  `[Layout.astro] Rendering for path: "${Astro.url.pathname}". Received showIndicatorOverride: ${showIndicatorOverride} (Type: ${typeof showIndicatorOverride})`
);

// Set a default title if none is provided
const pageTitle = `${title || siteConfig.metadata.title} | ${siteConfig.metadata.author}`;

// Determine if the scroll indicator should be shown
const currentPath = Astro.url.pathname;
const shouldShowBasedOnPath = currentPath === "/";
// Use override if provided, otherwise check path
const showScrollIndicator =
  showIndicatorOverride !== undefined ? showIndicatorOverride : shouldShowBasedOnPath;
// --- Add Detailed Log ---
console.log(
  `[Layout.astro] Path check result: ${shouldShowBasedOnPath}. Final showScrollIndicator decision: ${showScrollIndicator}`
);
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/png" href="/favicon.png" />
    <meta name="generator" content={Astro.generator} />
    <title>{pageTitle}</title>
    <meta name="description" content={siteConfig.metadata.description} />
    <meta name="author" content={siteConfig.metadata.author} />
    <ClientRouter />
    <!-- START Insert Theme Detection Script Here -->
    <script is:inline>
      // Simplified: Only check system preference
      const isDarkMode =
        window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
      if (isDarkMode) {
        document.documentElement.classList.add("dark");
      } else {
        document.documentElement.classList.remove("dark");
      }
    </script>
    <!-- END Insert Theme Detection Script Here -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400..800;1,400..800&display=swap"
      rel="stylesheet"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap"
      rel="stylesheet"
    />

    <script>
      let currentIntersectionObserver: IntersectionObserver | null = null; // Added type annotation

      document.addEventListener("astro:page-load", () => {
        // 1. Disconnect old observer if it exists
        if (currentIntersectionObserver) {
          currentIntersectionObserver.disconnect();
        }

        // 2. Set up the new observer for the current page
        const pageWrapper = document.querySelector(".page-wrapper");
        if (!pageWrapper) {
          console.error("Page wrapper element not found for IntersectionObserver.");
          return;
        }
        const observerOptions = {
          root: pageWrapper, // Observe intersections within the page-wrapper
          rootMargin: "0px",
          threshold: 0.2,
        };

        const observerCallback = (entries, observer) => {
          entries.forEach((entry) => {
            // console.log("Observing:", entry.target, "Is intersecting:", entry.isIntersecting); // Removed debug log
            if (entry.isIntersecting) {
              entry.target.classList.add("visible");
              observer.unobserve(entry.target);
            }
          });
        };

        const newObserver = new IntersectionObserver(observerCallback, observerOptions);

        // 3. Store the new observer instance
        currentIntersectionObserver = newObserver;

        // 4. Find and observe all elements with the scroll-reveal-animate class
        const elementsToObserve = document.querySelectorAll(".scroll-reveal-animate");
        elementsToObserve.forEach((el) => {
          newObserver.observe(el);
        });
      });
    </script>

    {/* === GSAP Section Animation Script === */}
    <script>
      // Import GSAP and ScrollTrigger directly here
      // Ensure GSAP is installed: npm install gsap
      import { gsap } from "gsap";
      import { ScrollTrigger } from "gsap/ScrollTrigger";

      // Register GSAP plugin
      gsap.registerPlugin(ScrollTrigger);

      function setupSectionAnimations() {
        const pageWrapper = document.querySelector(".page-wrapper");
        if (!pageWrapper) {
          console.warn("Section animations setup skipped: page wrapper not found.");
          return;
        }

        // Find all section wrappers rendered on the page
        const sections = document.querySelectorAll(".section-wrapper");

        // If sections exist, proceed with setting up animations
        if (sections.length > 0) {
          sections.forEach((section) => {
            const sectionTitle = section.querySelector(".scroll-target-title");
            const sectionContent = section.querySelector(".scroll-target-content");

            // Kill previous triggers associated with these specific elements
            ScrollTrigger.getAll().forEach((trigger) => {
              if (trigger.trigger === sectionTitle || trigger.trigger === sectionContent) {
                trigger.kill();
              }
            });

            // --- Section Title Animation ---
            if (sectionTitle) {
              gsap.set(sectionTitle, { filter: "blur(8px)", opacity: 0 });
              gsap
                .timeline({
                  scrollTrigger: {
                    trigger: sectionTitle,
                    scroller: pageWrapper,
                    start: "top 85%",
                    end: "bottom top",
                    scrub: 1,
                  },
                })
                .to(sectionTitle, { filter: "blur(0px)", opacity: 1, ease: "sine", duration: 8 })
                .to(sectionTitle, { filter: "blur(8px)", opacity: 0, ease: "sine", duration: 1 });
            }

            // --- Section Content Animation ---
            if (sectionContent) {
              gsap.set(sectionContent, { opacity: 0, y: 30 });
              gsap
                .timeline({
                  scrollTrigger: {
                    trigger: sectionContent,
                    scroller: pageWrapper,
                    start: "top 85%",
                    end: "bottom 30%",
                    scrub: 1,
                  },
                })
                .to(sectionContent, { opacity: 1, y: 0, ease: "power1.inOut", duration: 2 })
                .to(sectionContent, { opacity: 0, y: -30, ease: "power1.inOut", duration: 2 });
            }
          });
          console.log(`GSAP: Setup animations for ${sections.length} sections.`);
        } else {
          // Optionally kill all ScrollTriggers if no sections are found (e.g., on non-homepage?)
          // ScrollTrigger.getAll().forEach(trigger => trigger.kill());
        }
      }

      // Run setup on initial load and after SPA navigations
      document.addEventListener("astro:page-load", setupSectionAnimations);
    </script>
    <!-- System Theme Handling -->
    <script>
      const mediaQuery = window.matchMedia("(prefers-color-scheme: dark)");

      // Function to apply the theme class based on query match
      const checkAndApplyTheme = () => {
        if (mediaQuery.matches) {
          document.documentElement.classList.add("dark");
        } else {
          document.documentElement.classList.remove("dark");
        }
        console.log(
          "[Theme] Applied theme based on prefers-color-scheme:",
          mediaQuery.matches ? "dark" : "light"
        ); // Debug log
      };

      // Listener for live theme changes
      mediaQuery.addEventListener("change", checkAndApplyTheme);

      // Listener to re-apply theme after client-side navigation
      document.addEventListener("astro:page-load", checkAndApplyTheme);

      // Optional: Apply on initial script load for non-Astro SPA navigators?
      // The inline script should handle the very first load.
      // checkAndApplyTheme();
    </script>
  </head>
  <body>
    <div class="page-wrapper">
      <DynamicBackground />
      <main class="main-content">
        <slot />
      </main>
      <div class="some-empty-space" style="height: 20vh;"></div>
      <Footer />
      {/* Conditionally render ScrollIndicator */}
      {showScrollIndicator && <ScrollIndicator />}
    </div>
  </body>
</html>
