---

---

<div id="dynamic-background-container" transition:persist={true}>
  <canvas id="dynamic-background-canvas"></canvas>
</div>

<script>
  import { DynamicBackgroundManager } from "../lib/components/DynamicBackground";

  let backgroundManager: DynamicBackgroundManager | null = null;
  const supportsViewTransitions = "startViewTransition" in document;

  function initBackground() {
    const container = document.getElementById("dynamic-background-container");

    if (!container) {
      // Container is gone (navigated to a page without background), cleanup
      cleanupBackground();
      return;
    }

    // On browsers without View Transitions the DOM is swapped,
    // so tear down before re-initializing to avoid dangling canvas references.
    if (!supportsViewTransitions && backgroundManager) {
      cleanupBackground();
    }

    if (backgroundManager) return; // Prevent double init if already running on supported VT

    try {
      backgroundManager = new DynamicBackgroundManager(
        "dynamic-background-container",
        "dynamic-background-canvas"
      );
    } catch (e) {
      console.error("Failed to initialize DynamicBackground:", e);
    }
  }

  function cleanupBackground() {
    if (backgroundManager) {
      backgroundManager.cleanup();
      backgroundManager = null;
    }
  }

  // Initialize (or check persistence) on page load
  const handlePageLoad = () => initBackground();

  // Clean up on fallback swaps (Safari) where the element can't persist.
  const handleBeforeSwap = () => {
    if (!supportsViewTransitions) cleanupBackground();
    document.removeEventListener("astro:page-load", handlePageLoad);
    document.removeEventListener("astro:before-swap", handleBeforeSwap);
  };

  document.addEventListener("astro:page-load", handlePageLoad);
  document.addEventListener("astro:before-swap", handleBeforeSwap);
</script>

<style>
  #dynamic-background-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1;
    filter: blur(30px);
    opacity: var(--dynamic-bg-opacity);
  }

  /* Medium screens (e.g., tablets) */
  @media (min-width: 768px) {
    #dynamic-background-container {
      filter: blur(50px);
    }
  }

  /* Large screens (e.g., desktops) */
  @media (min-width: 1024px) {
    #dynamic-background-container {
      filter: blur(80px);
    }
  }

  #dynamic-background-canvas {
    display: block; /* Prevents extra space below canvas */
    width: 100%;
    height: 100%;
  }
</style>
