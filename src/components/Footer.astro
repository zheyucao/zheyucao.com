---
// Component: src/components/Footer.astro
import { siteConfig } from "../config";
import { getEntry } from "astro:content";
import { resolveLocaleFromPath, resolveLocalizedHref } from "../lib/i18n/locale";
import { getUiStrings } from "../lib/i18n/uiStrings";

const currentYear = new Date().getFullYear();
const { navigation } = siteConfig;
const locale = resolveLocaleFromPath(Astro.url.pathname);
const uiStrings = await getUiStrings(locale);
const { footer: footerStrings } = uiStrings;
const navigationLabels = uiStrings.navigation || {};

const footerData = await getEntry("footer", "info");
if (!footerData) {
  throw new Error("Could not find footer data");
}
const { author, description } = footerData.data;

// Load contact items for footer (single source of truth)
import { getContactFooterItems } from "../viewmodels/contactViewModel";

const contactFooterItems = await getContactFooterItems();
---

<footer
  class="site-footer py-16 px-[10%] min-h-[40vh] flex items-center relative z-5 font-sans md:px-[20%]"
>
  <div class="flex flex-wrap gap-8 w-full md:flex-nowrap md:gap-12">
    <div class="footer-column basis-full md:flex-[4_1_0%]">
      <h4 class="text-[var(--footer-heading)] mb-[1em] font-semibold">{author}</h4>
      <p class="m-0 text-[0.9rem] leading-[1.6] md:w-[75%]">
        {description}
      </p>
      <p class="mt-8 text-[0.8rem] text-[var(--footer-copyright)]">
        &copy; {currentYear}
        {author}. {footerStrings.copyrightText}.
      </p>
    </div>
    <div class="footer-column flex-1 md:flex-[1_1_0%]">
      <h4 class="text-[var(--footer-heading)] mb-[1em] font-semibold">
        {footerStrings.linksHeading}
      </h4>
      <ul class="footer-nav m-0 p-0 list-none text-[0.9rem] leading-[1.6]">
        {
          navigation.items.map((item) => (
            <li class="mb-[0.5em]">
              <a
                href={resolveLocalizedHref(item.href, Astro.url.pathname)}
                class="footer-link"
                data-astro-prefetch
              >
                {navigationLabels[item.href] || item.name}
              </a>
            </li>
          ))
        }
      </ul>
    </div>
    {
      contactFooterItems.length > 0 && (
        <div class="footer-column flex-1 md:flex-[1_1_0%]">
          <h4 class="text-[var(--footer-heading)] mb-[1em] font-semibold">
            {footerStrings.connectHeading}
          </h4>
          <ul class="m-0 p-0 list-none text-[0.9rem] leading-[1.6]">
            {contactFooterItems.map((item) => (
              <li class="mb-[0.5em]">
                <a
                  class="footer-link"
                  href={resolveLocalizedHref(item.href || "", Astro.url.pathname)}
                  target={item.target}
                  rel={item.rel}
                  aria-label={item.label || item.content || item.href}
                >
                  {item.label || item.content || item.href}
                </a>
              </li>
            ))}
          </ul>
        </div>
      )
    }
  </div>
</footer>

<style>
  /* Footer background and link colors - kept in CSS */
  .site-footer {
    background-color: var(--footer-bg);
    color: var(--footer-text);
    transition:
      background-color 0.3s ease,
      color 0.3s ease;
  }

  .footer-link {
    color: var(--footer-link);
    text-decoration: none;
    transition: color 0.2s ease;
  }

  .footer-link:hover,
  .footer-link:focus {
    color: var(--footer-link-hover);
    text-decoration: underline;
  }

  /* Hide active footer link */
  .footer-nav li.active {
    display: none;
  }
</style>

<script>
  import { onPageLifecycle } from "../lib/utils/pageLifecycle";
  import { querySelector } from "../lib/utils/dom";
  import { setupFooterAnimation } from "../lib/animations/footerAnimation";
  import { stripLocalePrefix } from "../lib/i18n/locale";

  function updateActiveFooterLink() {
    const currentPath = stripLocalePrefix(window.location.pathname);
    const normalizedPath = "/" + currentPath.replace(/^\/+|\/+$/g, "");
    const rootPath = "/";
    const links = document.querySelectorAll(".footer-nav li a");

    links.forEach((link) => {
      const linkHref = link.getAttribute("href");
      const linkParentLi = link.closest("li");
      if (!linkHref || !linkParentLi) return;
      const strippedHref = stripLocalePrefix(linkHref);
      const normalizedHref = "/" + strippedHref.replace(/^\/+|\/+$/g, "");

      linkParentLi.classList.remove("active");

      if (normalizedHref === rootPath && (currentPath === rootPath || currentPath === "/index.html")) {
        linkParentLi.classList.add("active");
      } else if (
        normalizedHref !== rootPath &&
        strippedHref.startsWith("/") &&
        !strippedHref.includes("#") &&
        normalizedHref === normalizedPath
      ) {
        linkParentLi.classList.add("active");
      }
    });
  }

  onPageLifecycle("footer", {
    onLoad: () => {
      updateActiveFooterLink();

      const footer = querySelector<HTMLElement>(".site-footer");
      const scroller = querySelector<HTMLElement>(".page-wrapper");

      if (footer && scroller) {
        return setupFooterAnimation({ footer, scroller });
      }
    },
  });
</script>
