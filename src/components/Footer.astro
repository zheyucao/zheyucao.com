---
// Component: src/components/Footer.astro
import { siteConfig } from "../config";
import { getEntry } from "astro:content";

const currentYear = new Date().getFullYear();
const { navigation } = siteConfig;

const uiStrings = await getEntry("ui-strings", "en");
if (!uiStrings) {
  throw new Error("Could not find UI strings for 'en'");
}
const { footer: footerStrings } = uiStrings.data;

const footerData = await getEntry("footer", "info");
if (!footerData) {
  throw new Error("Could not find footer data");
}
const { author, description } = footerData.data;

// Load contact items for footer (single source of truth)
import { getContactFooterItems } from "../viewmodels/contactViewModel";

const contactFooterItems = await getContactFooterItems();
---

<footer class="site-footer">
  <div class="footer-content">
    <div class="footer-column footer-column-1">
      <h4>{author}</h4>
      <p class="footer-description">
        {description}
      </p>
      <p class="copyright">
        &copy; {currentYear}
        {author}. {footerStrings.copyrightText}.
      </p>
    </div>
    <div class="footer-column footer-column-2">
      <h4>{footerStrings.linksHeading}</h4>
      <ul>
        {
          navigation.items.map((item) => (
            <li>
              <a href={item.href} data-astro-prefetch>
                {item.name}
              </a>
            </li>
          ))
        }
      </ul>
    </div>
    {
      contactFooterItems.length > 0 && (
        <div class="footer-column footer-column-3">
          <h4>{footerStrings.connectHeading}</h4>
          <ul>
            {contactFooterItems.map((item) => (
              <li>
                <a
                  class="link"
                  href={item.href}
                  target={item.target}
                  rel={item.rel}
                  aria-label={item.label || item.content || item.href}
                >
                  {item.label || item.content || item.href}
                </a>
              </li>
            ))}
          </ul>
        </div>
      )
    }
  </div>
</footer>

<style>
  .site-footer {
    background-color: var(--footer-bg);
    color: var(--footer-text);
    padding: 4rem 10%; /* Generous padding */
    /* min-height: 40vh; */ /* Let padding/content determine height */
    min-height: 40vh; /* Restore original height */
    display: flex;
    /* align-items: center; */ /* Remove vertical centering for now */
    align-items: center; /* Restore vertical centering */
    position: relative;
    z-index: 5;
    font-family: var(--font-family-sans);
    transition:
      background-color 0.3s ease,
      color 0.3s ease; /* Smooth theme transition */
  }

  .footer-content {
    display: flex;
    flex-wrap: wrap; /* Stack columns on mobile by default */
    gap: 2rem; /* Gap between columns when wrapped/stacked */
    width: 100%;
  }

  .footer-column {
    margin-bottom: 1.5rem; /* Spacing when stacked */
  }

  /* Mobile Layout: Col 1 full width, Col 2 & 3 side-by-side below */
  .footer-column-1 {
    flex-basis: 100%; /* Force to full width */
  }
  .footer-column-2,
  .footer-column-3 {
    flex: 1; /* Allow growing to fill the second row */
  }

  .footer-column h4 {
    color: var(--footer-heading);
    margin-bottom: 1em;
    font-weight: 600;
  }

  .footer-column p,
  .footer-column ul {
    margin: 0;
    padding: 0;
    list-style: none;
    font-size: 0.9rem;
    line-height: 1.6;
  }

  .footer-column ul li {
    margin-bottom: 0.5em;
  }

  .footer-column a {
    color: var(--footer-link);
    text-decoration: none;
    transition: color 0.2s ease;
  }

  .footer-column a:hover,
  .footer-column a:focus {
    color: var(--footer-link-hover);
    text-decoration: underline;
  }

  .footer-column p.copyright {
    margin-top: 2em;
    font-size: 0.8rem;
    color: var(--footer-copyright);
  }

  /* Style for the active footer link - Now hides the LI */
  .footer-column-2 ul li.active {
    /* Hide the entire list item */
    display: none;
  }

  /* Desktop layout: 3 columns with 2:1:1 ratio */
  @media (min-width: 768px) {
    .site-footer {
      padding: 4rem 20%; /* Generous padding */
    }
    .footer-content {
      flex-wrap: nowrap; /* Prevent wrapping on desktop */
      gap: 3rem; /* Adjust desktop gap */
    }
    .footer-column {
      margin-bottom: 0; /* Remove stacking margin */
    }
    .footer-column-1 {
      flex: 4 1 0%; /* 3 parts */
    }
    .footer-column-2,
    .footer-column-3 {
      flex: 1 1 0%; /* 1 part */
    }

    .footer-description {
      width: 75%;
    }
  }
</style>

<script>
  import { setupFooterAnimation } from "../lib/animations/footerAnimation";

  const FOOTER_ANIMATION_KEY = "__footerAnimationEventsRegistered__";
  type FooterWindow = Window & {
    [FOOTER_ANIMATION_KEY]?: boolean;
  };
  const footerWindow = window as FooterWindow;

  if (!footerWindow[FOOTER_ANIMATION_KEY]) {
    footerWindow[FOOTER_ANIMATION_KEY] = true;

    let cleanup: (() => void) | null = null;

    const handlePageLoad = () => {
      cleanup?.();

      const footer = document.querySelector(".site-footer") as HTMLElement | null;
      const scroller = document.querySelector(".page-wrapper") as HTMLElement | null;

      if (footer && scroller) {
        cleanup = setupFooterAnimation({ footer, scroller });
      }
    };

    // Cleanup on navigation, but keep listeners so they can re-run on the next page
    const handleBeforeSwap = () => {
      cleanup?.();
      cleanup = null;
    };

    document.addEventListener("astro:page-load", handlePageLoad);
    document.addEventListener("astro:before-swap", handleBeforeSwap);
  }
</script>

<script>
  // Client-side script to mark the active footer link
  const FOOTER_ACTIVE_LINK_KEY = "__footerActiveLinkEventsRegistered__";
  type FooterLinkWindow = Window & {
    [FOOTER_ACTIVE_LINK_KEY]?: boolean;
  };
  const footerLinkWindow = window as FooterLinkWindow;

  if (!footerLinkWindow[FOOTER_ACTIVE_LINK_KEY]) {
    footerLinkWindow[FOOTER_ACTIVE_LINK_KEY] = true;

    const updateActiveFooterLink = () => {
      const currentPath = window.location.pathname;
      const normalizedPath = "/" + currentPath.replace(/^\/+|\/+$/g, "");
      const rootPath = "/";
      const links = document.querySelectorAll(".footer-column-2 ul li a");

      links.forEach((link) => {
        const linkHref = link.getAttribute("href");
        const linkParentLi = link.closest("li");
        if (!linkHref || !linkParentLi) return;
        const normalizedHref = "/" + linkHref.replace(/^\/+|\/+$/g, "");

        linkParentLi.classList.remove("active"); // Remove active from all first

        if (linkHref === rootPath && (currentPath === rootPath || currentPath === "/index.html")) {
          linkParentLi.classList.add("active");
        } else if (
          linkHref !== rootPath &&
          linkHref.startsWith("/") &&
          !linkHref.includes("#") &&
          normalizedHref === normalizedPath
        ) {
          linkParentLi.classList.add("active");
        }
      });
    };

    // Run update on initial load and after SPA navigations
    const handlePageLoad = () => updateActiveFooterLink();
    const handleBeforeSwap = () => {
      // Keep listeners alive; just ensure the current run finishes cleanly
    };

    document.addEventListener("astro:page-load", handlePageLoad);
    document.addEventListener("astro:before-swap", handleBeforeSwap);
  }
</script>
