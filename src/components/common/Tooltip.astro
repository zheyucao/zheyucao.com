---
interface Props {
  triggerId: string;
  triggerEvent?: "hover" | "click";
  position?: "top" | "bottom" | "left" | "right";
  dismissAfter?: number; // milliseconds, only applies to click-triggered tooltips
  class?: string;
}

const {
  triggerId,
  triggerEvent = "hover",
  position = "bottom",
  dismissAfter = 2000,
  class: className = "",
} = Astro.props;
---

<div
  id={`tooltip-${triggerId}`}
  class={`tooltip-bubble ${position} trigger-${triggerEvent} ${className}`}
  role="tooltip"
  data-trigger-id={triggerId}
  data-position={position}
  data-trigger-event={triggerEvent}
  data-dismiss-after={dismissAfter}
>
  <slot />
</div>

<style>
  .tooltip-bubble {
    position: fixed; /* Fixed positioning relative to viewport */
    padding: none;
    border-radius: 8px;
    font-size: 0.8rem;
    line-height: 1.3;
    font-family: var(--font-family-sans);
    background: none;
    color: var(--text-color);
    opacity: 0;
    visibility: hidden;
    pointer-events: none;
    transition:
      opacity 0.16s ease,
      transform 0.16s ease,
      visibility 0.16s ease;
    z-index: 1000; /* High z-index to sit on top */
    max-width: 240px;
    text-align: center;
    white-space: normal;
  }

  /* Active state */
  .tooltip-bubble.active {
    opacity: 1;
    visibility: visible;
  }

  /* Copy active state (specific to ContactIcons usage) */
  .tooltip-bubble.copy-active {
    opacity: 1 !important;
    visibility: visible !important;
    pointer-events: auto;
  }

  /* --- Positioning Styles --- */

  /* Top */
  .tooltip-bubble.top {
    transform: translate(-50%, 10px); /* Start slightly down */
  }
  .tooltip-bubble.top.active,
  .tooltip-bubble.top.copy-active {
    transform: translate(-50%, 0);
  }

  /* Bottom */
  .tooltip-bubble.bottom {
    transform: translate(-50%, -10px); /* Start slightly up */
  }
  .tooltip-bubble.bottom.active,
  .tooltip-bubble.bottom.copy-active {
    transform: translate(-50%, 0);
  }

  /* Left */
  .tooltip-bubble.left {
    transform: translate(10px, -50%); /* Start slightly right */
  }
  .tooltip-bubble.left.active,
  .tooltip-bubble.left.copy-active {
    transform: translate(0, -50%);
  }

  /* Right */
  .tooltip-bubble.right {
    transform: translate(-10px, -50%); /* Start slightly left */
  }
  .tooltip-bubble.right.active,
  .tooltip-bubble.right.copy-active {
    transform: translate(0, -50%);
  }
</style>

<script>
  function setupTooltips() {
    const tooltips = document.querySelectorAll<HTMLElement>(".tooltip-bubble");

    tooltips.forEach((tooltip) => {
      const triggerId = tooltip.dataset.triggerId;
      if (!triggerId) return;

      const trigger = document.getElementById(triggerId);
      if (!trigger) {
        console.warn(`Tooltip trigger element with ID "${triggerId}" not found.`);
        return;
      }

      const position = tooltip.dataset.position || "bottom";
      const triggerEvent = tooltip.dataset.triggerEvent || "hover";
      const dismissAfter = parseInt(tooltip.dataset.dismissAfter || "2000", 10);

      // Move tooltip to body to avoid stacking context issues
      document.body.appendChild(tooltip);

      const updatePosition = () => {
        if (!trigger || !tooltip) return;

        const rect = trigger.getBoundingClientRect();
        const tooltipRect = tooltip.getBoundingClientRect();

        let top = 0;
        let left = 0;

        switch (position) {
          case "top":
            top = rect.top - tooltipRect.height;
            left = rect.left + rect.width / 2; // Centered horizontally
            break;
          case "bottom":
            top = rect.bottom;
            left = rect.left + rect.width / 2; // Centered horizontally
            break;
          case "left":
            // Since we use transform: translateY(-50%), top should be the center point
            top = rect.top + rect.height / 2;
            left = rect.left - tooltipRect.width - 16;
            break;
          case "right":
            top = rect.top + rect.height / 2; // Centered vertically
            left = rect.right + 16;
            break;
        }

        // Prevent overflow logic (simplified)
        // For top/bottom, we might want to clamp left
        // For left/right, we might want to clamp top

        tooltip.style.left = `${left}px`;
        tooltip.style.top = `${top}px`;
      };

      const show = () => {
        updatePosition();
        tooltip.classList.add("active");

        // Auto-dismiss click-triggered tooltips
        if (triggerEvent === "click") {
          setTimeout(() => {
            tooltip.classList.remove("active");
          }, dismissAfter);
        }
      };

      const hide = () => {
        tooltip.classList.remove("active");
      };

      const toggle = (e: Event) => {
        e.stopPropagation();
        if (tooltip.classList.contains("active")) {
          hide();
        } else {
          // Close others
          document.querySelectorAll(".tooltip-bubble.trigger-click").forEach((t) => {
            if (t !== tooltip) t.classList.remove("active");
          });
          show();
        }
      };

      // Event Listeners
      if (triggerEvent === "hover") {
        trigger.addEventListener("mouseenter", show);
        trigger.addEventListener("mouseleave", hide);
        trigger.addEventListener("focus", show);
        trigger.addEventListener("blur", hide);
      } else if (triggerEvent === "click") {
        trigger.addEventListener("click", toggle);
      }

      // Find the scrolling container (page-wrapper or window)
      const scrollContainer = document.querySelector(".page-wrapper") || window;

      // Update position on scroll/resize if active
      scrollContainer.addEventListener(
        "scroll",
        () => {
          if (tooltip.classList.contains("active")) updatePosition();
        },
        { passive: true }
      );

      window.addEventListener(
        "resize",
        () => {
          if (tooltip.classList.contains("active")) updatePosition();
        },
        { passive: true }
      );
    });

    // Global click to close click-triggered tooltips
    document.addEventListener("click", (e) => {
      const target = e.target as HTMLElement;
      // Don't close if clicking inside the tooltip itself (if interactive)
      if (target.closest(".tooltip-bubble")) return;

      document.querySelectorAll(".tooltip-bubble.trigger-click").forEach((t) => {
        // Don't close if clicking the trigger (handled by toggle)
        const id = (t as HTMLElement).dataset.triggerId;
        if (id && target.closest(`#${id}`)) return;

        t.classList.remove("active");
      });
    });

    // Escape key
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        document.querySelectorAll(".tooltip-bubble").forEach((t) => t.classList.remove("active"));
      }
    });
  }

  // Run on initial load
  setupTooltips();

  // Run on view transitions
  document.addEventListener("astro:after-swap", setupTooltips);
</script>
