---
import Tooltip from "../common/Tooltip.astro";
import { Icon } from "astro-icon/components";

interface ContactIconItem {
  icon: string;
  label?: string; // display label
  content?: string; // underlying value (e.g., number/handle) for copy/display
  href?: string;
  target?: string;
  rel?: string;
  description?: string;
}

interface Props {
  items?: ContactIconItem[];
}

const { items = [] } = Astro.props;
---

<div class="contact-icons">
  {
    items.map((item) => {
      const primaryLabel = item.content || item.href || "";
      const secondary = item.description || undefined;
      const copyValue = item.href ? undefined : item.content || item.href;
      return (
        <Tooltip label={primaryLabel} position="bottom">
          <div slot="bubble">
            <div class="tooltip-label" data-tooltip-label data-original-label={primaryLabel}>
              {primaryLabel}
            </div>
            {secondary && (
              <div class="tooltip-desc" data-tooltip-desc data-original-desc={secondary}>
                {secondary}
              </div>
            )}
          </div>
          {item.href ? (
            <a
              href={item.href}
              target={item.target}
              rel={item.rel}
              aria-label={primaryLabel}
              data-link-icon
            >
              <Icon name={item.icon} size={22} aria-hidden="true" />
            </a>
          ) : (
            <span
              class="icon-placeholder"
              role="img"
              aria-label={primaryLabel}
              data-copy-value={copyValue}
            >
              <Icon name={item.icon} size={22} aria-hidden="true" />
            </span>
          )}
        </Tooltip>
      );
    })
  }
</div>

<style>
  .contact-icons {
    display: flex;
    align-items: center;
    gap: 1.8rem;
  }

  .contact-icons a,
  .contact-icons .icon-placeholder {
    color: var(--theme-icon-color);
    opacity: 0.8;
    transition:
      opacity 0.2s ease,
      color 0.2s ease;
    display: inline-flex;
    align-items: center;
  }

  .contact-icons a:hover,
  .contact-icons a:focus,
  .contact-icons .icon-placeholder:hover,
  .contact-icons .icon-placeholder:focus {
    opacity: 1;
    color: var(--theme-accent);
    outline: none;
  }

  .contact-icons .icon-placeholder {
    cursor: pointer;
  }

  .contact-icons .icon-label {
    display: none;
    font-size: 0.8rem;
    line-height: 1.3;
    color: var(--text-muted);
  }

  .tooltip-bubble.copy-active {
    background: var(--button-hover-bg, rgba(0, 0, 0, 0.06));
    color: var(--theme-text, #111);
  }

  .tooltip.hide-bubble .tooltip-bubble {
    opacity: 0;
    visibility: hidden;
    transform: translate(-50%, 0);
  }

  /* Touch-friendly fallback: show labels instead of relying on hover */
  @media (hover: none) and (pointer: coarse) {
    .contact-icons {
      flex-wrap: wrap;
      gap: 1rem 1.4rem;
      justify-content: flex-start;
    }

    .contact-icons a,
    .contact-icons .icon-placeholder {
      flex-direction: column;
      align-items: center;
      gap: 0.35rem;
      text-decoration: none;
    }

    .contact-icons .icon-label {
      display: block;
      text-align: center;
    }
  }
</style>

<script>
  const handleCopy = async (el: Element, value: string) => {
    const tooltip = el.closest(".tooltip");
    const bubble = tooltip?.querySelector(".tooltip-bubble");
    const labelEl = tooltip?.querySelector("[data-tooltip-label]");
    const descEl = tooltip?.querySelector("[data-tooltip-desc]");

    try {
      await navigator.clipboard.writeText(value);

      if (labelEl) {
        const originalLabel =
          labelEl.getAttribute("data-original-label") || labelEl.textContent || "Copied!";
        const originalDesc =
          descEl?.getAttribute("data-original-desc") || descEl?.textContent || originalLabel;

        if (descEl) {
          descEl.textContent = "Copied!";
        } else {
          labelEl.textContent = "Copied!";
        }
        if (bubble) {
          bubble.classList.add("copy-active");
        }

        setTimeout(() => {
          labelEl.textContent = originalLabel;
          if (descEl) {
            descEl.textContent = originalDesc;
          }
          if (bubble) {
            bubble.classList.remove("copy-active");
          }
        }, 1200);
      }
    } catch (e) {
      console.error("Unable to copy contact value:", e);
    }
  };

  // Track listeners for cleanup
  const copyListeners = new Map();
  const linkListeners = new Map();

  document.addEventListener("astro:page-load", () => {
    const isCoarsePointer = window.matchMedia("(hover: none) and (pointer: coarse)").matches;
    const copyTargets = document.querySelectorAll(".contact-icons [data-copy-value]");
    copyTargets.forEach((el) => {
      const copyValue = el.getAttribute("data-copy-value") || "";
      if (isCoarsePointer && copyValue) {
        // On mobile, show value as primary and add a dedicated "Copied" secondary line
        const tooltip = el.closest(".tooltip");
        const labelEl = tooltip?.querySelector("[data-tooltip-label]");
        const descEl = tooltip?.querySelector("[data-tooltip-desc]");
        const bubble = tooltip?.querySelector(".tooltip-bubble");
        const newPrimary = copyValue;
        const newSecondary = "Copied";

        if (labelEl) {
          labelEl.textContent = newPrimary;
          labelEl.setAttribute("data-original-label", newPrimary);
        }

        let secondaryEl = descEl;
        if (!secondaryEl && bubble) {
          secondaryEl = document.createElement("div");
          secondaryEl.className = "tooltip-desc";
          secondaryEl.setAttribute("data-tooltip-desc", "");
          bubble.appendChild(secondaryEl);
        }

        if (secondaryEl) {
          secondaryEl.textContent = newSecondary;
          secondaryEl.setAttribute("data-original-desc", newSecondary);
        }
      }

      const handler = (event: Event) => {
        if (!copyValue) return;
        event.preventDefault();
        handleCopy(el, copyValue);
      };
      el.addEventListener("click", handler);
      copyListeners.set(el, handler);
    });

    const linkTargets = document.querySelectorAll(".contact-icons [data-link-icon]");
    linkTargets.forEach((el) => {
      const handler = () => {
        const tooltip = el.closest(".tooltip");
        if (!tooltip) return;
        tooltip.classList.add("hide-bubble");
        setTimeout(() => tooltip.classList.remove("hide-bubble"), 250);
      };
      el.addEventListener("click", handler);
      linkListeners.set(el, handler);
    });
  });

  // Cleanup on navigation
  document.addEventListener("astro:before-swap", () => {
    // Remove all copy listeners
    copyListeners.forEach((handler, el) => {
      el.removeEventListener("click", handler);
    });
    copyListeners.clear();

    // Remove all link listeners
    linkListeners.forEach((handler, el) => {
      el.removeEventListener("click", handler);
    });
    linkListeners.clear();
  });
</script>
