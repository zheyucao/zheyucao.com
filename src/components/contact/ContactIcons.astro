---
import Tooltip from "../common/Tooltip.astro";
import { Icon } from "astro-icon/components";

interface ContactIconItem {
  icon: string;
  label?: string; // display label
  content?: string; // underlying value (e.g., number/handle) for copy/display
  href?: string;
  target?: string;
  rel?: string;
  description?: string;
  copyOnClick?: boolean;
}

interface Props {
  items?: ContactIconItem[];
}

const { items = [] } = Astro.props;
---

<div class="contact-icons">
  {
    items.map((item, index) => {
      const value = item.content || item.href || item.label || "Link";
      const displayLabel = value;
      const description = item.description;
      const copyValue = item.copyOnClick === false || item.href ? undefined : value;
      const secondary = description || undefined;
      const triggerId = `contact-icon-${index}`;

      return (
        <>
          {item.href ? (
            <a
              id={triggerId}
              href={item.href}
              target={item.target}
              rel={item.rel}
              aria-label={displayLabel}
              data-link-icon
            >
              <Icon name={item.icon} size={22} aria-hidden="true" />
            </a>
          ) : (
            <span
              id={triggerId}
              class="icon-placeholder"
              role="img"
              aria-label={displayLabel}
              data-copy-value={copyValue}
              data-has-copy={copyValue ? "true" : "false"}
            >
              <Icon name={item.icon} size={22} aria-hidden="true" />
            </span>
          )}

          <Tooltip
            triggerId={triggerId}
            position="bottom"
            triggerEvent={copyValue ? "both" : "hover"}
          >
            <div class="tooltip-label" data-tooltip-label data-original-label={displayLabel}>
              {displayLabel}
            </div>
            {secondary && (
              <div class="tooltip-desc" data-tooltip-desc data-original-desc={secondary}>
                {secondary}
              </div>
            )}
          </Tooltip>
        </>
      );
    })
  }
</div>

<style>
  .contact-icons {
    display: flex;
    align-items: center;
    gap: 1.8rem;
  }

  .contact-icons a,
  .contact-icons .icon-placeholder {
    color: var(--theme-icon-color);
    opacity: 0.8;
    transition:
      opacity 0.2s ease,
      color 0.2s ease;
    display: inline-block;
  }

  .contact-icons a:hover,
  .contact-icons a:focus,
  .contact-icons .icon-placeholder:hover,
  .contact-icons .icon-placeholder:focus {
    opacity: 1;
    color: var(--theme-accent);
    outline: none;
  }

  .contact-icons .icon-placeholder {
    cursor: pointer;
  }

  .tooltip-bubble.copy-active {
    background: var(--button-hover-bg, rgba(0, 0, 0, 0.06));
    color: var(--theme-text, #111);
  }

  .tooltip.hide-bubble .tooltip-bubble {
    opacity: 0;
    visibility: hidden;
    transform: translate(-50%, 0);
  }
</style>

<script>
  const handleCopy = async (
    tooltip: any,
    labelEl: Element,
    descEl: Element | null,
    value: string,
    trigger: HTMLElement
  ) => {
    try {
      await navigator.clipboard.writeText(value);

      const originalLabel =
        labelEl.getAttribute("data-original-label") || labelEl.textContent || "Copied!";

      // Lock tooltip to prevent hover from interfering
      tooltip.lock();

      // Show "Copied!" message
      labelEl.textContent = "Copied!";

      if (descEl) {
        (descEl as HTMLElement).style.display = "none";
      }

      // Force show tooltip with copy styling
      tooltip.classList.add("copy-active");
      tooltip.forceShow();

      // Restore original content after delay
      setTimeout(() => {
        labelEl.textContent = originalLabel;
        if (descEl) {
          (descEl as HTMLElement).style.display = "";
        }
        tooltip.classList.remove("copy-active");

        // Unlock first so hover can work
        tooltip.unlock();

        // Check if user is still hovering - if so, keep tooltip visible with restored content
        // Otherwise hide it
        if (trigger.matches(":hover")) {
          // User is still hovering, keep tooltip visible with original content
          tooltip.forceShow();
        } else {
          tooltip.forceHide();
        }
      }, 1200);
    } catch (e) {
      console.error("Unable to copy contact value:", e);
    }
  };

  document.addEventListener("astro:page-load", () => {
    // Listen for tooltip:click events
    document.addEventListener("tooltip:click", async (e: any) => {
      const { trigger, tooltip } = e.detail;
      const copyValue = trigger.getAttribute("data-copy-value");

      if (!copyValue) return;

      const labelEl = tooltip.querySelector("[data-tooltip-label]");
      const descEl = tooltip.querySelector("[data-tooltip-desc]");

      if (labelEl) {
        await handleCopy(tooltip, labelEl, descEl, copyValue, trigger);
      }
    });
  });
</script>
